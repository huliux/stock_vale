# 系统架构模式

## 核心架构 (Streamlit 应用 + FastAPI 后端)
- **前端 UI (Streamlit):**
    - 使用 Streamlit 构建交互式用户界面。
    - 通过调用后端 API 获取数据和计算结果。
- **后端 API (FastAPI):**
    - **职责:** 提供数据获取、核心 DCF 计算、LLM 分析调用等服务。
    - **分层架构:** API 层 (Routers), 服务层 (包含估值协调、LLM 调用), 数据访问层 (Data Fetchers), 计算模块 (拆分后的 DCF 逻辑)。
    - **依赖注入:** FastAPI 内建支持。
    - **数据验证/序列化:** 使用 Pydantic 模型。
    - **实现约束:** **所有模块的实现细节（特别是数据处理、计算公式和逻辑）必须严格遵循 `wiki/` 目录下的 PRD 和数据定义文档。**

## 设计模式应用
- **数据获取:** **策略模式 (Strategy Pattern)** (保持) 用于支持多市场数据源。
- **估值计算:** **模块化设计** (新) 将 DCF 计算流程拆分为多个职责单一的类/模块 (NWC, FCF, WACC, TV, PV, Equity Bridge)。
- **LLM 调用:** **适配器模式 (Adapter Pattern)** (新) 可能用于封装不同 LLM 服务商的 API 调用，提供统一接口。
- **报告生成:** (已移除) 不再需要旧的报告生成模式。

## 数据处理
- **数据标准化:** 在 Data Fetcher 层将不同来源的数据转换为统一内部结构。
- **数据标准化:** (保持) 在 Data Fetcher 和 Data Processor 层进行。
- **配置管理:** **外部化配置** (新) 使用 `.env` 文件管理数据库凭证、API Keys、默认参数；使用配置文件管理 LLM Prompt 模板。

## 错误处理
- **API 错误处理:** (保持) 定义统一的 HTTP 错误响应模型。
- **数据处理警告:** (新) `DataProcessor` 记录数据清洗和计算过程中的警告信息，并通过 API 传递给前端。
- **LLM 调用错误处理:** (新) 需要处理 LLM API 调用失败或返回异常的情况。
