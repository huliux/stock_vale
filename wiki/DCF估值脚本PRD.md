# **DCF 估值脚本产品需求文档 (PRD)**

## **1\. 引言**

本文档详细描述了一个基于数据库数据的DCF（现金流折现法）估值Python脚本的需求。该脚本旨在通过预测公司未来的自由现金流（Free Cash Flow, FCF），计算其现值，并结合终值，从而得出公司的企业价值和股权价值，最终计算出隐含的股票价格。数据来源于预设的数据库结构，包括资产负债表、现金流量表、利润表和股票基本信息表。

## **2\. 目标**

* 实现一套准确、可靠的DCF估值计算流程。  
* 利用现有数据库中的财务数据进行历史分析和未来预测。  
* 提供清晰的估值结果，包括预测期FCF、WACC、终值、企业价值、股权价值和隐含股票价格。  
* 支持用户输入关键假设，以进行敏感性分析。

## **3\. 用户故事**

* 作为一个财务分析师，我希望能够输入公司代码和估值基准日期，脚本能自动从数据库获取历史数据并进行DCF估值计算。  
* 作为一个投资者，我希望能够调整关键的预测假设（如增长率、WACC、退出乘数），以便了解这些假设对公司估值的影响。  
* 作为一个研究员，我希望脚本能输出详细的计算过程和中间结果，以便我验证模型的逻辑和数据来源。

## **4\. 功能需求**

### **4.1 数据获取**

* 脚本应能够连接到指定的数据库。  
* 根据用户输入的股票代码（ts\_code）和估值基准日期，从balance\_sheet, cash\_flow, income\_statement, 和 valuation\_metrics表中提取指定历史期间的财务数据和最新的股票基本信息。  
* 需要获取至少过去3-5年的年度财务数据（report\_type='ANN', end\_type='报告期类型' 通常为年度）。  
* 获取最新的股票基本信息以获取总股本等信息。

### **4.2 财务预测**

* 基于获取的历史数据和用户输入的预测假设，预测未来指定预测期（例如5-10年）的财务关键指标。  
* 预测指标包括但不限于：销售额、销货成本、销售/管理/研发费用、折旧与摊销、资本性支出、营运资本各构成项。  
* 预测方法应支持基于历史平均比率、固定比率、固定增长率等多种方式，并允许用户指定。

### **4.3 自由现金流 (FCF) 计算**

* 根据预测的财务指标，计算预测期内每年的无杠杆自由现金流（UFCF）。

### **4.4 WACC 计算**

* 根据用户输入的WACC计算所需参数（无风险利率、市场风险溢价、目标资本结构、Beta等），计算加权平均资本成本（WACC）。  
* Beta计算应支持使用可比公司数据计算无杠杆Beta，然后根据目标资本结构再杠杆化。

### **4.5 终值 (Terminal Value) 计算**

* 支持使用退出乘数法计算预测期最后一年的终值。  
* 终值计算应基于预测期最后一年的EBITDA和用户指定的退出乘数。

### **4.6 现值计算**

* 使用计算出的WACC作为折现率，将预测期各年的UFCF和终值折现到估值基准日的现值。

### **4.7 估值结果**

* 计算企业价值 (Enterprise Value, EV)。  
* 计算隐含股权价值 (Equity Value)。  
* 计算隐含股票价格。

### **4.8 敏感性分析**

* 允许用户调整关键假设（如销售额增长率、WACC、退出乘数），并重新计算估值结果，以展示敏感性。

### **4.9 结果输出**

* 将详细的计算过程、中间结果和最终估值结果清晰地输出（例如，打印到控制台、保存到文件或数据库）。

## **5\. 数据来源与字段映射**

数据主要来源于以下数据库表：

* **balance\_sheet (资产负债表)**  
  * end\_date: 报告期  
  * total\_cur\_assets: 流动资产合计  
  * total\_cur\_liab: 流动负债合计  
  * money\_cap: 货币资金 (用于现金及现金等价物)  
  * lt\_borr: 长期借款 (用于债务总额)  
  * st\_borr: 短期借款 (用于债务总额)  
  * bond\_payable: 应付债券 (用于债务总额)  
  * minority\_int: 少数股东权益  
  * total\_share: 期末总股本 (用于全面摊薄已发行股票数量的基础)  
  * accounts\_receiv\_bill: 应收票据及应收账款 (用于营运资本预测)  
  * inventories: 存货 (用于营运资本预测)  
  * prepayment: 预付款项 (用于营运资本预测)  
  * accounts\_pay: 应付票据及应付账款 (用于营运资本预测)  
  * payroll\_payable: 应付职工薪酬 (用于营运资本预测 \- 应计负债部分)  
  * taxes\_payable: 应交税费 (用于营运资本预测 \- 应计负债部分)  
  * oth\_payable: 其他应付款 (用于营运资本预测 \- 应计负债部分)  
  * adv\_receipts 或 contract\_liab: 预收款项/合同负债 (用于营运资本预测)  
  * total\_liab: 负债合计 (用于债务总额校验或其他分析)  
  * total\_assets: 资产总计  
* **cash\_flow (现金流量表)**  
  * end\_date: 报告期  
  * depr\_fa\_coga\_dpba: 固定资产折旧、油气资产折耗、生产性生物资产折旧 (用于折旧与摊销)  
  * amort\_intang\_assets: 无形资产摊销 (用于折旧与摊销)  
  * lt\_amort\_deferred\_exp: 长期待摊费用摊销 (用于折旧与摊销)  
  * c\_pay\_acq\_const\_fiolta: 购建固定资产、无形资产和其他长期资产支付的现金 (用于资本性支出 CapEx)  
  * n\_cashflow\_act: 经营活动产生的现金流量净额 (用于历史FCF参考，预测期使用间接法计算所需科目)  
  * c\_fr\_sale\_sg: 销售商品、提供劳务收到的现金 (用于营运资本周转天数计算的分母)  
  * c\_paid\_goods\_s: 购买商品、接受劳务支付的现金 (用于营运资本周转天数计算的分母)  
* **income\_statement (利润表)**  
  * end\_date: 报告期  
  * total\_revenue: 营业总收入 (用于销售额)  
  * revenue: 营业收入 (用于销售额，根据实际情况选择 total\_revenue 或 revenue)  
  * oper\_cost: 营业成本 (用于销货成本)  
  * sell\_exp: 销售费用 (用于销售/管理/研发费用)  
  * admin\_exp: 管理费用 (用于销售/管理/研发费用)  
  * rd\_exp: 研发费用 (用于销售/管理/研发费用)  
  * fin\_exp: 财务费用 (用于EBIT计算，需要调整利息收支)  
  * fin\_exp\_int\_exp: 财务费用:利息费用 (用于EBIT调整和税后债务成本)  
  * fin\_exp\_int\_inc: 财务费用:利息收入 (用于EBIT调整)  
  * income\_tax: 所得税费用 (用于所得税税率计算)  
  * total\_profit: 利润总额 (用于所得税税率计算)  
  * operate\_profit: 营业利润 (EBIT的参考)  
  * ebit: 息税前利润 (如果数据库提供，可直接使用)  
  * ebitda: 息税折旧摊销前利润 (如果数据库提供，可直接使用，用于终值计算)  
* **valuation\_metrics (股票估值指标表)**  
  * trade\_date: 交易日期 (获取最新日期)  
  * ts\_code: 股票代码  
  * total\_share: 总股本（亿） (用于全面摊薄已发行股票数量的基础，注意单位转换)

## **6\. 计算逻辑与公式**

### **6.1 历史数据处理**

* 根据用户输入的股票代码和估值基准日期，提取指定历史期间的年度财务数据。  
* 计算历史期间的关键财务比率或周转天数，作为预测期的参考或基础。例如：  
  * 销货成本占销售额比率 \= oper\_cost / total\_revenue  
  * 销售/管理/研发费用占销售额比率 \= (sell\_exp \+ admin\_exp \+ rd\_exp) / total\_revenue  
  * 折旧与摊销占销售额比率 \= (折旧摊销总额) / total\_revenue  
  * 资本性支出占销售额比率 \= c\_pay\_acq\_const\_fiolta / total\_revenue  
  * 应收账款周转天数 \= accounts\_receiv\_bill / (revenue / 360\) (假设年销售额，360天)  
  * 存货周转天数 \= inventories / (oper\_cost / 360\) (假设年销货成本，360天)  
  * 应付账款周转天数 \= accounts\_pay / (c\_paid\_goods\_s / 360\) (假设年购买商品支付现金，360天)  
  * 营运资本净额 \= total\_cur\_assets \- total\_cur\_liab  
  * 营运资本占销售额比率 \= 营运资本净额 / total\_revenue  
  * 所得税率 \= income\_tax / total\_profit (需要处理利润总额为0或负数的情况)

### **6.2 财务预测 (预测期 t)**

* **销售额:** 销售额t​=销售额t−1​×(1+销售额增长率t​)  
* **预测期销售额增长率:** 可以是每年固定增长率，分阶段增长率，或基于历史复合增长率（CAGR）并逐年降低相对增长比例。  
  * 历史 CAGR 计算：CAGR=(期初销售额期末销售额​)年数1​−1  
  * 未来增长率预测：预测期第t年的增长率=历史CAGR×(1−逐年递减比例)t (其中 t 为预测期年份序号，从1开始)  
* **销货成本占销售额比率预测:** 基于历史平均比率并逐年调整相对比例。  
  * 历史平均比率 \= 历史期年数∑历史期各年销货成本占销售额比率​  
  * 预测期第t年的比率 \= 历史平均比率 ×(1−逐年调整比例)t  
* **销售/管理/研发费用占销售额比率预测:** 基于历史平均比率并逐年调整相对比例。  
  * 历史平均比率 \= 历史期年数∑历史期各年销售/管理/研发费用占销售额比率​  
  * 预测期第t年的比率 \= 历史平均比率 ×(1−逐年调整比例)t  
* **折旧与摊销 (D\&A) 占销售额比率预测:** 基于历史平均比率并逐年调整相对比例。  
  * 历史平均比率 \= 历史期年数∑历史期各年折旧与摊销占销售额比率​  
  * 预测期第t年的比率 \= 历史平均比率 ×(1−逐年调整比例)t  
* **资本性支出 (CapEx) 占销售额比率预测:** 基于历史平均比率并逐年调整相对比例。  
  * 历史平均比率 \= 历史期年数∑历史期各年资本性支出占销售额比率​  
  * 预测期第t年的比率 \= 历史平均比率 ×(1−逐年调整比例)t  
* **营运资本各构成项预测:** 根据历史平均比率或周转天数并逐年调整相对比例。例如：  
  * **应收账款周转天数预测:**  
    * 历史平均天数 \= 历史期年数∑历史期各年应收账款周转天数​  
    * 预测期第t年的天数 \= 历史平均天数 ×(1−逐年调整比例)t  
    * 应收账款t​=销售额t​/360×预测期第t年的应收账款周转天数  
  * **存货周转天数预测:**  
    * 历史平均天数 \= 历史期年数∑历史期各年存货周转天数​  
    * 预测期第t年的天数 \= 历史平均天数 ×(1−逐年调整比例)t  
    * 存货t​=销货成本t​/360×预测期第t年的存货周转天数  
  * **应付账款周转天数预测:**  
    * 历史平均天数 \= 历史期年数∑历史期各年应付账款周转天数​  
    * 预测期第t年的天数 \= 历史平均天数 ×(1−逐年调整比例)t  
    * 应付账款t​=销货成本t​/360×预测期第t年的应付账款周转天数  
  * 应计负债、预收款项等类似方法预测（基于占销售额比率预测）。  
    * 历史平均比率 \= 历史期年数∑历史期各年应计负债/预收款项占销售额比率​  
    * 预测期第t年的比率 \= 历史平均比率 ×(1−逐年调整比例)t  
    * 应计负债/预收款项t​=销售额t​×预测期第t年的应计负债/预收款项占销售额比率  
* **营运资本净额:** 营运资本净额t​=∑流动资产预测值t​−∑流动负债预测值t​  
* **营运资本增加/(减少):** ΔWCt​=营运资本净额t​−营运资本净额t−1​

### **6.3 自由现金流 (FCF) 计算 (预测期 t)**

* **EBIT:** EBITt​=销售额t​−销货成本t​−销售/管理/研发费用t​ (简化，实际需考虑其他营业收支)  
* **税后 EBIT (EBIAT):** EBIATt​=EBITt​×(1−预测所得税率)  
* **无杠杆自由现金流 (UFCF):** UFCF\_t \= EBIAT\_t \+ D\&A\_t \- CapEx\_t \- \\Delta WC\_t

### **6.4 WACC 计算**

* **税后债务成本:** 税后债务成本=债务成本×(1−预测所得税率)  
* **权益成本 (CAPM):**  
  * 获取可比公司数据并计算无杠杆 Beta（该步骤可能需要额外数据源或用户输入）。  
  * 计算目标公司杠杆化 Beta: 杠杆化Beta=无杠杆Beta×(1+(1−预测所得税率)×目标债务/权益比例)  
  * 权益成本 \= 无风险利率 \+ 杠杆化 Beta × 市场风险溢价 \+ 规模溢价  
* **WACC:** WACC=(目标权益/资本总额比率×权益成本)+(目标债务/资本总额比率×税后债务成本)

### **6.5 终值 (Terminal Value) 计算**

* **终值年 EBITDA:** 取预测期最后一年的 EBITDA 预测值。  
* **终值 (退出乘数法):** 终值=终值年EBITDA×退出乘数

### **6.6 现值计算**

* **贴现因子:** 贴现因子t​=1/(1+WACC)折现期t​ (折现期为从估值基准日到预测期末的时间，例如，预测第一年折现期为1，第二年为2，以此类推，终值折现期为预测期年数)  
* **预测期 FCF 现值:** FCF现值t​=UFCFt​×贴现因子t​  
* **终值现值:** 终值现值=终值×终值年贴现因子

### **6.7 估值结果**

* **FCF 累计现值:** FCF累计现值=∑t=1预测期年数​FCF现值t​  
* **企业价值 (EV):** 企业价值=FCF累计现值+终值现值  
* **隐含股权价值:** 隐含股权价值=企业价值−债务总额−优先股−少数股东权益+现金及现金等价物  
  * 债务总额 \= lt\_borr \+ st\_borr \+ bond\_payable (或其他所有附息债务总和)  
  * 现金及现金等价物 \= money\_cap (或 c\_cash\_equ\_end\_period)  
  * 优先股：假设为0，如存在需从数据库获取或用户输入。  
  * 少数股东权益 \= minority\_int  
* **全面摊薄已发行股票数量:** 获取最新的 total\_share (总股本)，并考虑潜在稀释（如股票期权、可转债等，如果数据库提供相关信息或用户输入）。根据提供的文件，初步假设等于总股本。  
* **隐含股票价格:** 隐含股票价格=隐含股权价值/全面摊薄已发行股票数量

## **7\. 假设**

脚本需要用户输入或使用预设的假设：

* **预测期年数:** 例如 5 年或 10 年。  
* **预测期销售额增长率预测方法:** 选择固定增长率、分阶段增长率，或基于历史复合增长率（CAGR）并逐年降低相对增长比例。如果选择后者，需要输入逐年递减比例。  
* **预测期各项成本费用占销售额比率预测方法:** 选择固定比率或基于历史平均比率并逐年调整相对比例。如果选择后者，需要输入逐年调整比例。  
* **预测期折旧与摊销占销售额比率预测方法:** 选择固定比率或基于历史平均比率并逐年调整相对比例。如果选择后者，需要输入逐年调整比例。  
* **预测期资本性支出占销售额比率预测方法:** 选择固定比率或基于历史平均比率并逐年调整相对比例。如果选择后者，需要输入逐年调整比例。  
* **预测期营运资本各构成项预测方法:** 选择固定比率/周转天数或基于历史平均比率/周转天数并逐年调整相对比例。如果选择后者，需要输入逐年调整比例。  
* **预测期所得税率。**  
* **WACC 计算参数:** 无风险利率、市场风险溢价、目标资本结构（债务/权益比例）、Beta（如果不支持自动计算，需要用户输入）。  
* **终值计算参数:** 退出乘数。  
* **估值基准日期:** 用于确定历史数据提取截止日期和未来现金流的折现起点。

## **8\. 输出**

脚本应输出以下信息：

* 输入的股票代码和估值基准日期。  
* 关键预测假设列表。  
* 预测期每年详细的财务预测结果（销售额、成本、费用、D\&A, CapEx, 营运资本变化）。  
* 预测期每年计算出的 UFCF。  
* 计算出的 WACC。  
* 计算出的终值及其现值。  
* 预测期 FCF 累计现值。  
* 计算出的企业价值。  
* 计算出的隐含股权价值。  
* 计算出的全面摊薄已发行股票数量。  
* 计算出的隐含股票价格。  
* 敏感性分析结果表格（如果实现）。

## **9\. 非功能性需求**

* **准确性:** 计算结果必须准确，与DCF模型原理一致。  
* **可靠性:** 脚本应能稳定运行，正确处理数据库连接和数据查询错误。  
* **可维护性:** 代码结构清晰，模块化，易于理解和修改。  
* **性能:** 对于单个公司的估值，计算应在合理的时间内完成。  
* **数据依赖:** 脚本完全依赖于提供的数据库结构和数据。