# 系统架构模式

## 核心架构 (Streamlit 应用 + FastAPI 后端)
- **前端 UI (Streamlit):**
    - 使用 Streamlit 构建交互式用户界面。
    - **交互模式:** 主内容区域用于展示核心估值结果和LLM分析，侧边栏 (`st.sidebar`) 用于集中的参数输入和复杂配置（如敏感性分析的详细设置）。
    - 通过调用后端 API 获取数据和计算结果。
- **后端 API (FastAPI):**
    - **职责:** 提供数据获取、核心 DCF 计算（支持单次计算和敏感性分析）、LLM 分析调用等服务。
    - **分层架构:** API 层 (Routers), 服务层 (包含估值协调、敏感性分析循环处理、LLM 调用), 数据访问层 (Data Fetchers), 计算模块 (拆分后的 DCF 逻辑)。(注：敏感性分析可能需要进一步封装核心估值流程以便重复调用)。
    - **依赖注入:** FastAPI 内建支持。
    - **数据验证/序列化:** 使用 Pydantic 模型。
    - **实现约束:** **所有模块的实现细节（特别是数据处理、计算公式和逻辑）必须严格遵循 `wiki/` 目录下的 PRD 和数据定义文档。**

## 设计模式应用
- **数据获取:** **策略模式 (Strategy Pattern)** (保持) 用于支持多市场数据源。
- **估值计算:** **模块化设计** (新) 将 DCF 计算流程拆分为多个职责单一的类/模块 (NWC, FCF, WACC, TV, PV, Equity Bridge)。
- **LLM 调用:** 
    - **统一接口与适配:** `api/llm_utils.py` 中的 `call_llm_api` 函数作为统一接口，根据传入的 `provider` 参数适配调用不同的 LLM 服务。
    - **支持的提供商:**
        - **DeepSeek:** 通过 `requests`库直接调用其 API。
        - **自定义 OpenAI 兼容模型:** 通过 `openai` Python SDK 调用，允许用户指定 API Base URL 和模型 ID。
    - **配置驱动:** API 密钥、默认模型 ID、默认 API Base URL（用于自定义模型）、以及 Temperature/Top-P/Max Tokens 等默认参数均从 `.env` 文件加载。前端 UI 提供选项以覆盖这些默认参数。
- **报告生成:** (已移除) 不再需要旧的报告生成模式。

## 数据处理
- **数据标准化:** 在 Data Fetcher 层将不同来源的数据转换为统一内部结构。
- **数据标准化:** (保持) 在 Data Fetcher 和 Data Processor 层进行。
- **配置管理:** **外部化配置** (新) 使用 `.env` 文件管理数据库凭证、API Keys、默认参数；使用配置文件管理 LLM Prompt 模板。

## 股票筛选器模块 (新功能 - 已整合)
- **定位:** 作为主 Streamlit 应用 (`streamlit_app.py`) 内的一个**标签页 (Tab)**，与“DCF估值”功能并列。
- **UI布局:**
    - **筛选条件输入与数据管理:** 统一放置在应用的侧边栏 (`st.sidebar`)，与DCF估值的参数输入共享侧边栏空间，并使用UI分隔符（例如 `st.divider()` 或视觉上的区隔）进行组织。包括PE、PB、市值范围输入，以及“更新股票基础数据”、“更新每日行情指标”按钮和数据显示状态。
    - **筛选结果展示:** 在“股票筛选器”标签页的主内容区域使用 `st.dataframe` 展示。
- **数据源与处理 (`stock_screener_data.py`):**
    - 直接调用 Tushare Pro API 获取股票基本信息 (`pro.stock_basic`) 和每日行情指标 (`pro.daily_basic`)。
    - `stock_basic` 数据：首次获取后进行本地文件 (`.feather`) 持久化缓存，后续由用户手动触发更新。
    - `daily_basic` 数据：按交易日进行本地文件 (`.feather`) 持久化缓存，后续由用户手动选择日期并触发更新。
    - 数据合并 (Pandas DataFrame) 和基础预处理（如数值类型转换、市值单位转换）在 `stock_screener_data.py` 中完成。
- **与核心估值服务的关系与联动:**
    - **数据流独立:** 筛选器的数据获取和处理不直接依赖或影响后端FastAPI估值服务。
    - **功能联动:**
        - 筛选器用于初步筛选股票代码。
        - 在筛选结果表格的每一行，提供“进行估值”按钮。
        - 点击按钮后，自动将该股票的 `ts_code` 填充到“DCF估值”标签页的股票代码输入框，并自动切换到“DCF估值”标签页，方便用户进行后续的详细估值。填充代码后不自动触发估值计算，等待用户确认参数后手动发起。

## 错误处理
- **API 错误处理:** (保持) 定义统一的 HTTP 错误响应模型。
- **数据处理警告:** (新) `DataProcessor` 记录数据清洗和计算过程中的警告信息，并通过 API 传递给前端。
- **LLM 调用错误处理:** (新) 需要处理 LLM API 调用失败或返回异常的情况。

## 已知局限性与未来方向
- **行业适用性:**
    - 当前核心 DCF 估值逻辑主要针对非金融类企业设计。对于银行、保险、证券等金融行业，由于其财务报表结构和核心业务模式的显著差异，模型的适用性有限，估值结果可能存在较大偏差。
    - 系统会尝试识别金融行业公司，并在数据质量不佳时（通常由科目不匹配导致）在 UI 层面给出特别警告。
    - **未来方向:** 考虑通过策略模式或引入独立的估值模块，为金融等特定行业开发和集成更适用的估值模型（如 FCFE、剩余收益模型、内含价值模型等）。
