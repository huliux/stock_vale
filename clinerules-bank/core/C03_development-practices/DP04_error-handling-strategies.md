# 通用错误处理策略指南

本文档提供了关于在软件开发中设计和实现健壮错误处理机制的通用策略和最佳实践。有效的错误处理对于构建可靠、用户友好且易于调试的应用程序至关重要。

## 1. 错误处理的核心原则

*   **尽早捕获，延迟处理 (Catch Early, Handle Late - sometimes):**
    *   在错误可能发生的最早地点检测和捕获错误。
    *   但错误的处理（如向用户显示消息、记录日志、执行回退逻辑）可能在调用栈的更高层级进行，那里有更充分的上下文来决定如何恰当处理。
*   **明确区分预期错误与意外错误 (Expected vs. Unexpected Errors):**
    *   **预期错误：** 已知的、可能发生的错误情况（如用户输入无效、文件未找到、网络连接超时）。应有明确的处理逻辑。
    *   **意外错误 (Bugs)：** 程序缺陷导致的未预料到的错误。通常应导致程序失败（fail-fast），记录详细信息供调试，并可能向用户显示通用错误消息。
*   **提供有意义的错误信息 (Meaningful Error Messages):**
    *   **对用户：** 错误信息应清晰、简洁、易于理解，避免技术术语，并尽可能提供如何解决问题的建议。
    *   **对开发者/运维：** 日志中的错误信息应包含足够的上下文（如错误类型、发生位置、堆栈跟踪、相关数据），以便快速定位和诊断问题。
*   **保持系统稳定与一致 (Maintain System Stability and Consistency):**
    *   错误处理逻辑不应使系统进入不稳定或不一致的状态。
    *   考虑事务管理、资源清理（如关闭文件、释放锁）、回滚操作。
*   **避免暴露敏感信息 (Do Not Expose Sensitive Information):**
    *   错误消息（尤其是向用户显示的）不应包含敏感数据（如堆栈跟踪的内部细节、数据库查询语句、配置信息）。
*   **统一错误处理策略 (Consistent Error Handling Strategy):**
    *   在应用的各个层面（API、业务逻辑、UI）采用一致的错误报告和处理方式。
    *   （例如：许多Web框架（如FastAPI、Spring Boot）提供了统一处理HTTP异常的机制，并允许开发者定义统一的错误响应模型。项目特定的错误处理模式应在对应的项目文档（如记忆库中的系统模式文档）中详细说明。）

## 2. 常见的错误处理技术

*   **异常处理 (Exception Handling - try/catch/finally):**
    *   大多数现代编程语言提供的标准错误处理机制。
    *   使用 `try` 块包裹可能抛出异常的代码。
    *   使用 `catch` (或 `except` in Python) 块捕获并处理特定类型的异常。
    *   使用 `finally` (或 `else/finally` in Python) 块执行无论是否发生异常都需要执行的清理代码。
    *   **最佳实践：**
        *   只捕获你知道如何处理的特定异常。避免捕获过于通用的异常（如 `Exception` 或 `Throwable`）然后忽略它。
        *   不要用异常来控制正常的程序流程。
        *   自定义异常类型可以更好地表达业务相关的错误。
*   **返回值/错误码 (Return Values/Error Codes):**
    *   函数通过返回特殊值（如 `null`, `-1`, `false`）或特定的错误码来指示错误。
    *   调用者需要检查返回值来判断操作是否成功。
    *   在某些语言（如 Go）或特定场景（如 C 语言接口）中常见。
    *   **缺点：** 容易被调用者忽略检查，错误信息传递不如异常丰富。
*   **Option/Maybe/Result 类型 (Functional Programming):**
    *   在函数式编程语言或支持此类概念的语言中，使用如 `Option<T>` (表示值可能存在或不存在) 或 `Result<T, E>` (表示操作成功并返回值 `T`，或失败并返回错误 `E`) 类型来显式处理可能失败的操作。
    *   强制调用者处理潜在的空值或错误情况。
*   **断言 (Assertions):**
    *   用于在开发和测试阶段检查程序内部的不变式 (invariants) 或前置/后置条件。
    *   如果断言失败，通常表示程序存在缺陷，应导致程序终止。
    *   不应用于处理可预期的运行时错误。

## 3. 不同层面的错误处理

*   **用户界面 (UI) 层：**
    *   向用户显示友好、易懂的错误消息。
    *   引导用户修正输入或重试操作。
    *   避免显示技术细节。
*   **API 层：**
    *   使用标准的 HTTP 状态码指示错误类型。
    *   在响应体中提供结构化的错误信息 (如 JSON)。
    *   记录详细的服务器端错误日志。
    *   （例如：一些Web框架（如FastAPI）与其数据验证库（如Pydantic）集成，可以自动处理数据验证错误并返回标准化的错误响应，如HTTP 422状态码及详细错误信息。）
*   **业务逻辑层：**
    *   捕获并处理与业务规则相关的预期错误。
    *   可能需要将底层错误（如数据库连接错误）转换为更抽象的业务异常。
*   **数据访问层：**
    *   处理与数据存储相关的错误（如连接失败、查询超时、数据不存在）。

## 4. 错误日志记录 (Logging)

*   **记录什么：** 时间戳、错误级别（ERROR, WARNING）、错误消息、异常类型、堆栈跟踪、发生模块/函数、用户ID（如果适用且已脱敏）、请求ID（用于追踪分布式系统中的请求）。
*   **日志级别：** 合理使用不同的日志级别（DEBUG, INFO, WARNING, ERROR, CRITICAL）以方便筛选和分析。
*   **结构化日志：** 考虑使用结构化日志格式（如 JSON），便于机器解析和集中式日志系统处理。
*   **避免在日志中记录敏感数据。**

---

健壮的错误处理是构建高质量软件的关键组成部分。应在整个开发生命周期中持续关注和改进错误处理策略。
